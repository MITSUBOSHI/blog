<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Isucon10予選 振り返り - mitsubosh's blog</title><link rel=stylesheet type=text/css href=/blog/css/main.css></head><body><header><div><h1><a href=https://mitsuboshi.github.io/blog/>mitsubosh's blog</a></h1></div><nav></nav></header><main><article><div class=title><h1>Isucon10予選 振り返り</h1></div><div style=position:fixed;right:-30px;max-width:300px;overflow:auto;top:1px;width:300px;bottom:100px><div class="container text-center mt-3"><iframe src="https://duckduckgo.com/search.html?site=https://mitsuboshi.github.io/blog/&prefill=" style=overflow:hidden;margin:0;padding:0;max-width:80%;height:40px frameborder=0></iframe></div></div><div class=meta><div>2020-09-14 12:32</div><div><span><a href=https://mitsuboshi.github.io/blog/tags/tech/>#tech</a></span>
<span><a href=https://mitsuboshi.github.io/blog/tags/isucon/>#isucon</a></span></div></div><div class=content><p>isucon10予選、おつかれさまでした。<br>チーム名はコーヒーフロート。ひとりぼっちの初参加です。<br>最高得点は718点で、<a href=http://isucon.net/archives/55008744.html>最終得点は662点</a>。</p><h2 id=感想>感想</h2><p>終了後に他の参加者のdiscord上での会話やブログを追って読むと、「そもそもそんなアプローチ閃かなかった！」と思えるものが多く、いかに自分が狭い範囲で戦っていたのかと悔しい気持ちになりました。<br>一方で、いざというときにそのカードが切れのるかというのは日々の積み重ねだとも思っています。そういった意味だと、自分がいざというときに戦える範囲を認識できたのは良かったです。<br>そもそも「思いつかなかったけどできなかった」ではなく「思いつかなかった」も多かったので、しっかり復習していきます。</p><p>isuumo、とても楽しかったです！<br>運営の皆さん、ありがとうございました。</p><h2 id=時間毎の出来事>時間毎の出来事</h2><h3 id=1200->12:00 ~</h3><ul><li>レッドブルの蓋を開ける。</li><li>開始直後にportalサイトが502になる。</li><li>当日マニュアルが配布されていたのでそれを熟読。</li><li>portalサイトにアクセス出来るようになるがportal上からサーバーリストが閲覧出来ない。<ul><li>マニュアルにチームIDごとのサーバー情報が記載されていたので、それを正としてlocalの <code>~/.ssh/config</code> 設定。</li></ul></li><li>ようやくサーバーに入る。</li><li>参考実装の切り替えをデフォのgo -> rubyに変更。</li><li>サーバーの構成と対象のappのコード眺めつつ、ブラウザでapp触る。</li><li>12:51にディレクトリ毎localに落として、initial commitをする。<ul><li>今回rubyを選択したのもあり、rubyディレクトリだけ落としていた。</li></ul></li></ul><h3 id=1300->13:00 ~</h3><ul><li>13:00ちょうどにnewrelicの設定をする。<ul><li><a href=https://github.com/tanaka-takayoshi/isucon9-final/commit/d7fca852a17fceb94511a7a2bea4847074549afc>https://github.com/tanaka-takayoshi/isucon9-final/commit/d7fca852a17fceb94511a7a2bea4847074549afc</a> の参考実装に助けられました。</li></ul></li><li>mysqld.confをlocalに落としてきて、設定変更・再起動。<ul><li>query_cache系の変更。</li><li>slow_query系の変更。<ul><li><code>long_query_time=0.01</code> にしてほぼ出力するようにした。</li></ul></li></ul></li></ul><h3 id=1400->14:00 ~</h3><ul><li>unicornの設定をゴニョゴニョいじる。<ul><li>unicorn起動しなくなり焦る。</li><li>systemdのserviceだったことを完全に忘れていた。<ul><li><code>/etc/systemd/system/isuumo.ruby.service</code> をlessで見て、心を落ち着かせる。</li></ul></li><li>systemctlでサービスを起こす。</li></ul></li><li>nginxの設定ファイル落としてきて、ファイルキャッシュ等の設定。</li></ul><h3 id=1500->15:00 ~</h3><ul><li>初回ベンチマーク回せるようになった。初回スコアが602。</li><li><code>mysqldumpslow</code> でslowqueryを眺めたり、newrelicを眺めたり、nginx/access.log眺める。</li><li>各テーブルにINDEXを作成する。</li><li>app側のsqlを修正。</li></ul><h3 id=1600->16:00 ~</h3><ul><li>nginxでbotアクセスを弾くようにする。</li><li>細かい修正ミスが目立つようになり焦る。</li><li>喫煙のため離席をする。</li></ul><h3 id=1700->17:00 ~</h3><ul><li><code>explain</code> でINDEX使われているか確認すると、全く使われていないことに気づく。<ul><li>いや、そもそもpossible_keysに何も出ていない。</li></ul></li><li><code>POST /initialize</code> されると、データ再生成されるのは雑に把握していたけど、<code>DROP DATABASE</code> していることにようやく気づく。</li><li><code>mysql/db/0_Schema.sql</code> にINDEX作成するステートメント書く。</li></ul><h3 id=1800->18:00 ~</h3><ul><li>app側で出来る高速化が無いか色々試す。</li><li>newrelic上で重いエンドポイントを確認する。<ul><li><code>GET /api/chair/search</code></li><li><code>GET /api/estate/search</code></li><li><code>POST /api/estate/nazotte</code></li></ul></li><li>nazotteの改善に挑戦するも時間内で解決策が見つかるとも思えず断念。</li></ul><h3 id=1900->19:00 ~</h3><ul><li>search系なら行けるだろうと思って色々試す。</li><li>重いクエリをslow_query.logから引っ張り出し、<code>FORCE INDEX</code> 付けてexplainをしたりする。<ul><li>良さそうな結果が得られたものはapp側で <code>USE INDEX</code> or <code>FORCE INDEX</code> 付けてみてベンチマークを回してみる。</li></ul></li><li>深みにハマっていく。。。</li></ul><h3 id=2000->20:00 ~</h3><ul><li>自己最高の718点をマーク。</li><li>しかし、いろいろいじっていたらスコアが600台前半くらいまで落ちて泣きそうになる。</li><li>newrelicなどパフォーマンス計測用処理などをコード内から削除していく。</li><li>苦し紛れに最後回したら662点。</li></ul><h3 id=2100->21:00 ~</h3><ul><li>再起動出来ることの確認。</li></ul></div><div style=position:fixed;right:50px;max-width:255px;overflow:auto;top:120px;width:220px;bottom:90px><div class=toc><div class=page-header><strong>目录</strong></div><div id=page-scrollspy class=toc-nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%84%9f%e6%83%b3>感想</a></li></ul></ul><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#%e6%99%82%e9%96%93%e6%af%8e%e3%81%ae%e5%87%ba%e6%9d%a5%e4%ba%8b>時間毎の出来事</a></li></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1200->12:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1300->13:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1400->14:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1500->15:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1600->16:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1700->17:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1800->18:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#1900->19:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#2000->20:00 ~</a></li></ul></ul></ul><ul class=nav><ul class=nav><ul class=nav><li class=nav-item><a class="nav-link text-left" href=#2100->21:00 ~</a></li></ul></ul></ul></div></div></div></article></main><footer><div><div>&copy; 2019 Linlin Yan. <a href=https://creativecommons.org/licenses/by/4.0/deed.zh>CC-BY-4.0</a></div></div></footer></body></html>