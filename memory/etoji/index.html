<!doctype html><html lang=ja><head><title>RubyのWebAssemblyを試してみた - mitsubosh's blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel=stylesheet><link rel=stylesheet href=https://mitsuboshi.github.io/blog/css/bootstrap.css><link rel=stylesheet href=https://mitsuboshi.github.io/blog/css/custom.css></head><body><main id=main><div class=container><div class="row justify-content-center text-center my-5"><div class=col-lg-10><a href=https://mitsuboshi.github.io/blog/categories/ja/ class="d-inline-block link-cta mb-4 text-uppercase">ja</a><h1 class="mb-4 text-center">RubyのWebAssemblyを試してみた</h1><p class="small mb-5 text-center"><span class=text-uppercase>January 10, 2023</span></p></div></div></div><div class="bg-skew bg-skew-light"><div class=container><div class="row justify-content-center"><div class=col-lg-8><article class=pb-2><p>年始に育児の合間を縫ってRuby3.2で少しだけ遊んでみました。<br>上の子が絵本『<a href=https://www.amazon.co.jp/dp/4774604097>十二支のはじまり</a>』を最近読んで、干支を認識し始めて来たので、それに関連したものを簡易的に作りました。</p><p><a href=https://mitsuboshi.github.io/eto/>https://mitsuboshi.github.io/eto/</a></p><p><del>※iOS/Android端末のブラウザでは上手く動作しないです</del><br>※2024-01に動くようになりました</p><h2 id=gem-etoji>gem &ldquo;etoji&rdquo;</h2><p><a href=https://github.com/MITSUBOSHI/etoji>https://github.com/MITSUBOSHI/etoji</a></p><p>以下のように西暦から対象となる干支(十二支)のデータを取得するシンプルなgemです。<br>(<code>geto</code> はget + 干支の造語)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>require <span style=color:#e6db74>&#39;etoji&#39;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Etoji</span><span style=color:#f92672>.</span>geto(<span style=color:#e6db74>year</span>: <span style=color:#ae81ff>2023</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># =&gt; #&lt;data Etoji::Jyunishi::Animal</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  number=4,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  emoji=&#34;🐰&#34;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  character=&#34;卯&#34;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  character_hiragana_kun=&#34;う&#34;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  character_hiragana_on=&#34;ぼう&#34;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  animal_name_ja=&#34;兎&#34;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  animal_name_ja_hiragana=&#34;うさぎ&#34;,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#  animal_name_en=&#34;rabbit&#34;&gt;</span>
</span></span></code></pre></div><p>モダンなRubyを書いてみたく、<code>Data</code> クラス や パターンマッチを使ってみました。<br>パターンマッチはずっと使いたいと思っていたんですが、中々使う機会が無かったの、無理やり使いました(が、今回のケースはcase-whenで十分なことに後で気づいた)。</p><p>Steep(RBS)で型チェックを試してみました。<br><code>Data</code> クラスのrbsファイルは公式にまだ存在しなかったり、case-inの記法を使うと『Syntax <code>case_match</code> is not supported in Steep』と <code>Ruby::UnsupportedSyntax</code> になったりとやや困りました。<br>typeprofでrbsファイルの雛形生成をして、untypedな型定義を修正していく体験は良かったです。</p><p>sorbet(RBI)の<a href=https://github.com/Shopify/tapioca>Shopify/tapioca</a>のようにRails application向けに良い感じなrbsファイルを吐き出せたり、
ディレクトリ構成に沿って型ファイルを吐き出せるようになるとより嬉しいです。</p><h3 id=refs>Refs</h3><ul><li><a href=https://github.com/tbpgr/eto>https://github.com/tbpgr/eto</a><ul><li>既に似たgemが存在していたので、参考にさせてもらいました</li></ul></li><li><a href=https://github.com/github/gemoji>https://github.com/github/gemoji</a><ul><li>干支(十干・十二支)のデータの管理の仕方は、このgemの <code>db/emoji.json</code> 参考にしました</li></ul></li><li><a href=https://ja.wikipedia.org/wiki/%E5%B9%B2%E6%94%AF>https://ja.wikipedia.org/wiki/干支</a></li></ul><h2 id=webassembly>WebAssembly</h2><p><a href=https://github.com/MITSUBOSHI/eto>https://github.com/MITSUBOSHI/eto</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl -L https://github.com/ruby/ruby.wasm/releases/latest/download/ruby-head-wasm32-unknown-wasi-full-js.tar.gz | tar xfvz -
</span></span><span style=display:flex><span>$ mv head-wasm32-unknown-wasi-full-js/usr/local/bin/ruby ruby.wasm
</span></span><span style=display:flex><span>$ wasi-vfs pack ruby.wasm --mapdir /usr::./head-wasm32-unknown-wasi-full-js/usr --mapdir /etoji::./etoji -o docs/etoji.wasm
</span></span></code></pre></div><p>でetoji libraryを梱包してWASMを試すことが出来ました。<br>(本当はbundler経由でgem &ldquo;etoji"を利用したかったが、手を抜きました。後で試そうと思います。)<br>最初公式repoのREADME等を読まずに何も考えず <code>ruby-head-wasm32-unknown-wasi-full</code> を利用していたため、ブラウザで必要な <code>rb-js-abi-host</code> が存在せず動かないなどお粗末なことをしました。<br>(<a href=https://github.com/ruby/ruby.wasm/tree/main/ext>https://github.com/ruby/ruby.wasm/tree/main/ext</a> が必須)</p><p>「見た目は後で整えればいいだろう」「一旦、子どもに見せるか」と思って、iPhoneで動作しないことに気づき悲しくなりました。<br>macOS上のChrome/Safariでは問題なく動作はしていて、iOS * WebAssemblyで雑に調べるとメモリ関連で苦しんでいる記事をいくつか目にしたところで時間切れになったので、深追いしていません。</p><p>いつか仕事でもバックエンドとフロントエンドを共通ロジック(同一ソース)でバリデーションをさせるなどの用途でWebAssemblyを使うなどしてみたい気持ちです。</p><h3 id=refs-1>Refs</h3><ul><li><a href=https://zenn.dev/koduki/articles/3619f53e8c0575>https://zenn.dev/koduki/articles/3619f53e8c0575</a></li><li><a href=https://github.com/kateinoigakukun/wasi-vfs/wiki/Getting-Started-with-CRuby>https://github.com/kateinoigakukun/wasi-vfs/wiki/Getting-Started-with-CRuby</a></li><li><a href=https://github.com/ruby-syntax-tree/ruby-syntax-tree.github.io>https://github.com/ruby-syntax-tree/ruby-syntax-tree.github.io</a></li></ul><h2 id=追記2024-01-06>追記(2024-01-06)</h2><p>iOS/Androidで動作しなかった原因はwasmファイルのfetchを無駄に繰り返し行っていた点だった。</p><p class="mt-5 text-center"><span class=text-secondary>Tagged: </span><a href=https://mitsuboshi.github.io/blog/tags/ruby/ class="link-tag text-dark">#ruby</a>
<a href=https://mitsuboshi.github.io/blog/tags/wasm/ class="link-tag text-dark">#wasm</a>
<a href=https://mitsuboshi.github.io/blog/tags/tech/ class="link-tag text-dark">#tech</a></p></article><div class="row pt-5 pb-5"><div class="col-6 text-left"><a class=text-reset href=https://mitsuboshi.github.io/blog/memory/looking-back-2022/>&larr; 2022年の振り返り</a></div><div class="col-6 text-right"><a class=text-reset href=https://mitsuboshi.github.io/blog/memory/homebuilt-pc-2023/>自作PC: 2023 &rarr;</a></div></div></div></div></div></div></main><footer class="site-footer mt-5"><div class=container><div class="row justify-content-md-between"><div class="col-sm-12 col-md-4 mb-4"><h2 class="h5 mb-3">mitsubosh's blog</h2><p></p></div><div class="col-4 col-md-2 mb-4"><h2 class="h5 mb-3">Menu</h2><ul class="nav flex-column"><li class=mb-1><a href=https://mitsuboshi.github.io/blog/ class=text-secondary>Home</a></li></ul></div></div><hr><div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-center"><div class="text-muted mb-3">© 2020 MITSUBOSHI Yuya
<a href=https://10mohi6.tk class=text-reset>design</a> <a href=https://github.com/10mohi6/hugo-theme-simple-blog class=text-reset>theme</a></p></div></div></div></footer></body></html>